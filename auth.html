<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dual Authentication </title>
<style>
:root{
  --bg:#0b1220; --card:#0f1724; --muted:#9aa6b2;
  --accent1:#6ee7b7; --accent2:#60a5fa;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
body{
  margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(180deg,#071028,#08152a);color:#e6eef6;
}
.wrap{width:480px;max-width:96vw;padding:18px;}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));
  border-radius:14px;padding:22px;box-shadow:0 12px 50px rgba(2,6,23,0.6);
  overflow:hidden;transform:translateY(18px);opacity:0;
  transition:transform .5s cubic-bezier(.2,.9,.2,1),opacity .5s;
}
.card.enter{transform:none;opacity:1;}
h1{margin:0 0 6px;font-size:22px;text-align:center;}
p.lead{margin:0 0 14px;color:var(--muted);text-align:center;}
form{display:flex;flex-direction:column;gap:10px;}
.row{display:flex;gap:10px;}
.col{flex:1;}
input,select{
  background:transparent;border:1px solid rgba(255,255,255,0.08);
  padding:10px;border-radius:10px;color:inherit;width:100%;
}
.controls{display:flex;gap:10px;margin-top:10px;}
button{border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;}
.login{background:linear-gradient(90deg,var(--accent2),#3b82f6);color:#04243a;flex:1;}
.register{background:linear-gradient(90deg,var(--accent1),#34d399);color:#04201a;flex:1;}
.hint{font-size:13px;color:var(--muted);text-align:center;margin-top:10px;}
.status{text-align:center;font-size:14px;color:var(--muted);margin-top:6px;min-height:22px;}
.overlay{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(4,8,14,0.55);z-index:60;opacity:0;pointer-events:none;
  transition:opacity .25s;
}
.overlay.show{opacity:1;pointer-events:auto;}
.loader-card{
  background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(0,0,0,0.08));
  padding:18px;border-radius:12px;display:flex;gap:12px;align-items:center;
  backdrop-filter:blur(6px);
}
.spinner{width:48px;height:48px;border-radius:50%;position:relative;}
.spinner:before{
  content:'';position:absolute;inset:0;border-radius:50%;
  background:conic-gradient(from 0deg,var(--accent1),var(--accent2),var(--accent1));
  filter:blur(6px);
}
.spinner:after{
  content:'';position:absolute;inset:8px;border-radius:50%;
  background:linear-gradient(180deg,rgba(0,0,0,0.12),rgba(255,255,255,0.02));
}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.spinner-inner{position:absolute;inset:0;border-radius:50%;animation:spin 1.6s linear infinite;}
.success{
  position:fixed;left:50%;top:15%;transform:translateX(-50%) translateY(-10px);
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  color:#02110b;padding:12px 18px;border-radius:12px;
  box-shadow:0 12px 40px rgba(2,6,23,0.6);
  opacity:0;pointer-events:none;transition:opacity .4s,transform .4s;z-index:70;
}
.success.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto;}
.mode-outer{position:relative;min-height:260px;}
.mode-panel{position:absolute;inset:0;transition:opacity .28s,transform .35s;}
.mode-panel.hidden{opacity:0;transform:translateY(8px);pointer-events:none;}
.mode-panel.visible{opacity:1;transform:none;pointer-events:auto;}
.remember-row{display:flex;align-items:center;gap:8px;margin-top:8px;color:var(--muted);font-size:13px;}
.remember-row input{transform:translateY(1px);}
</style>
</head>
<body>
<div class="wrap">
  <div id="authCard" class="card">
    <h1>User Authentication</h1>
    <p class="lead">Register or login </p>

    <div class="mode-outer">
      <!-- REGISTER -->
      <div id="panel-register" class="mode-panel visible">
        <form id="register-form" novalidate>
          <div class="row">
            <input id="fullName" class="col" placeholder="Full Name" autocomplete="name" />
          </div>
          <div class="row">
            <input id="displayName" class="col" placeholder="Username" autocomplete="nickname" />
            <input id="age" class="col" type="number" min="1" placeholder="Age" />
          </div>
          <div class="row">
            <select id="gender" class="col">
              <option value="">Gender</option><option>Male</option><option>Female</option><option>Other</option>
            </select>
          </div>
          <input id="regEmail" type="email" placeholder="Email" autocomplete="email" />
          <input id="regPassword" type="password" placeholder="Password (min 8 chars)" autocomplete="new-password" />
          <input id="regPasskey" type="password" placeholder="Passkey (auto-filled)" autocomplete="new-password" readonly />
        </form>
      </div>

      <!-- LOGIN -->
      <div id="panel-login" class="mode-panel hidden">
        <form id="login-form" novalidate>
          <input id="loginEmail" type="email" placeholder="Email" autocomplete="email" />
          <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" />
          <input id="loginPasskey" type="password" placeholder="Passkey (auto-filled)" autocomplete="current-password" readonly />
        </form>
        <div style="text-align:right;margin-top:6px;">
          <a href="#" id="forgotLink" style="font-size:13px;color:var(--accent2);text-decoration:none;display:none;">
            Forgot password?
          </a>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="btn-login" class="login">Login</button>
      <button id="btn-register" class="register">Register</button>
    </div>

    <div class="remember-row">
      <input id="remember" type="checkbox" />
      <label for="remember">Remember me (stay signed in)</label>
    </div>

    <div id="hint" class="hint">Don’t have an account? Click Register.</div>
    <div id="msg" class="status">Initializing...</div>
  </div>
</div>

<div id="overlay" class="overlay">
  <div class="loader-card">
    <div class="spinner"><div class="spinner-inner"></div></div>
    <div>
      <div style="font-weight:600">Authenticating…</div>
      <div id="overlayMsg" style="font-size:13px;color:rgba(0,0,0,0.6)">Connecting to servers</div>
    </div>
  </div>
</div>

<div id="success" class="success">Success — redirecting…</div>

<script type="module">
const PUBLIC_URL = 'https://patel-102.github.io/Fantasy/firebase.js';
const PRIVATE_URL = 'https://patel-102.github.io/Fantasy/private.js';

import {
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  updateProfile,
  sendEmailVerification,
  sendPasswordResetEmail,
  setPersistence,
  browserLocalPersistence,
  browserSessionPersistence,
  onAuthStateChanged
} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js';
import { doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

// UI elements
const authCard = document.getElementById('authCard');
const overlay = document.getElementById('overlay');
const overlayMsg = document.getElementById('overlayMsg');
const success = document.getElementById('success');
const msg = document.getElementById('msg');
const hint = document.getElementById('hint');
const panelRegister = document.getElementById('panel-register');
const panelLogin = document.getElementById('panel-login');
const btnLogin = document.getElementById('btn-login');
const btnRegister = document.getElementById('btn-register');
const rememberCheckbox = document.getElementById('remember');
const forgotLink = document.getElementById('forgotLink');

// passkey autofill
const regPassword=document.getElementById('regPassword');
const regPasskey=document.getElementById('regPasskey');
const loginPassword=document.getElementById('loginPassword');
const loginPasskey=document.getElementById('loginPasskey');
regPassword.addEventListener('input',()=>{ regPasskey.value=regPassword.value; });
loginPassword.addEventListener('input',()=>{ loginPasskey.value=loginPassword.value; });

// animation
window.requestAnimationFrame(()=> setTimeout(()=> authCard.classList.add('enter'), 120));
function setMsg(t,c='info'){ msg.textContent = t; msg.style.color = (c==='err')? '#ff9aa2' : '#8ef3c3'; }
function showOverlay(text){ overlayMsg.textContent = text; overlay.classList.add('show'); }
function hideOverlay(){ overlay.classList.remove('show'); }
function showSuccess(text){ success.textContent = text; success.classList.add('show'); }

async function tryImport(url){ try{ return await import(url + '?t=' + Date.now()); }catch(e){ return null; } }
function resolveInstance(mod){ if(!mod) return null; const auth = mod.auth || mod.default?.auth || null; const db = mod.db || mod.default?.db || null; return auth ? { auth, db } : null; }

let INSTANCES = { public: null, private: null };
let READY = false;

async function init(){
  setMsg('Loading Firebase projects...');
  const [pMod, prMod] = await Promise.all([tryImport(PUBLIC_URL), tryImport(PRIVATE_URL)]);
  INSTANCES.public = resolveInstance(pMod);
  INSTANCES.private = resolveInstance(prMod);

  if(!INSTANCES.public && !INSTANCES.private){
    setMsg('Unable to load Firebase configs.', 'err'); READY = false; return;
  }
  if(!INSTANCES.public || !INSTANCES.private){
    setMsg('Partial connection.'); 
  } else setMsg('Ready — choose Login or Register.');

  READY = true;

  try {
    const checkAuthFor = (inst) => new Promise((resolve) => {
      if (!inst?.auth) return resolve(null);
      const unsub = onAuthStateChanged(inst.auth, (user) => { try { unsub(); } catch(e){} resolve(user || null); });
    });
    const userPub = await checkAuthFor(INSTANCES.public);
    const userPriv = await checkAuthFor(INSTANCES.private);
    const activeUser = userPub || userPriv;
    if (activeUser) {
      showSuccess('Welcome back!');
      setTimeout(()=> window.location.href='global.html', 800);
      return;
    }
  } catch (e) { console.warn('Auto-login failed', e); }
}

// Mode toggle
function showRegisterMode(){
  panelRegister.classList.add('visible'); panelRegister.classList.remove('hidden');
  panelLogin.classList.add('hidden'); panelLogin.classList.remove('visible');
  hint.textContent = 'Already have an account? Click Login.';
  forgotLink.style.display = 'none';
}
function showLoginMode(){
  panelLogin.classList.add('visible'); panelLogin.classList.remove('hidden');
  panelRegister.classList.add('hidden'); panelRegister.classList.remove('visible');
  hint.textContent = "Don’t have an account? Click Register.";
  forgotLink.style.display = 'inline';
}

function translateFirebaseError(err){
  const code = (err && err.code) || '';
  switch(code){
    case 'auth/invalid-email': return 'Invalid email address.';
    case 'auth/user-disabled': return 'User disabled.';
    case 'auth/user-not-found': return 'No user found.';
    case 'auth/wrong-password': return 'Incorrect password.';
    case 'auth/email-already-in-use': return 'Email already in use.';
    case 'auth/weak-password': return 'Weak password.';
    default: return err.message || String(err);
  }
}

async function ensureProfileInDb(db, uid, profile){
  if(!db) return;
  try{
    const ref = doc(db, 'users', uid);
    const snap = await getDoc(ref);
    if(!snap.exists()) await setDoc(ref, profile);
    else await setDoc(ref, {...snap.data(), ...profile});
  }catch(e){ console.warn('Profile save failed', e); }
}

// REGISTER
btnRegister.addEventListener('click', async ()=>{
  if(!READY){ setMsg('Still loading Firebase configs.', 'err'); return; }
  showRegisterMode();

  const email = document.getElementById('regEmail').value.trim();
  const password = regPassword.value;
  const passkey = regPasskey.value;
  const fullName = document.getElementById('fullName').value.trim();
  const displayName = document.getElementById('displayName').value.trim() || fullName || email.split('@')[0];
  const age = parseInt(document.getElementById('age').value||'0',10) || null;
  const gender = document.getElementById('gender').value || '';

  if(!email || !password){ setMsg('Enter email and password.', 'err'); return; }
  if(password.length < 8){ setMsg('Password must be at least 8 chars.', 'err'); return; }
  if(password !== passkey){ setMsg('Password and Passkey must match.', 'err'); return; }

  const profile = {
    username: displayName, fullName, age, gender, email,
    bio:'', phone:'', photoURL:'https://patel-102.github.io/Fantasy/Avatar/Avatar1.png',
    createdAt:new Date().toISOString()
  };

  showOverlay('Creating account…'); btnLogin.disabled = btnRegister.disabled = true;
  const persistence = rememberCheckbox.checked ? browserLocalPersistence : browserSessionPersistence;

  try{
    if(INSTANCES.public?.auth) await setPersistence(INSTANCES.public.auth, persistence);
    if(INSTANCES.private?.auth) await setPersistence(INSTANCES.private.auth, persistence);

    async function safeCreate(inst){
      if(!inst) return null;
      try{
        const cred = await createUserWithEmailAndPassword(inst.auth, email, password);
        const u = cred.user;
        await updateProfile(u,{displayName});
        if(inst.db) await ensureProfileInDb(inst.db, u.uid, profile);
        try{ await sendEmailVerification(u);}catch(e){}
        return u;
      }catch{ return null; }
    }

    const rPub = await safeCreate(INSTANCES.public);
    const rPriv = await safeCreate(INSTANCES.private);
    const primary = rPub || rPriv;
    if(!primary) throw new Error('Failed to create account.');

    showSuccess('Account created! Redirecting…');
    hideOverlay(); setMsg('Registration successful');
    setTimeout(()=> authFadeAndRedirect(), 1000);
  }catch(err){ hideOverlay(); setMsg(translateFirebaseError(err), 'err'); }
  finally{ btnLogin.disabled = btnRegister.disabled = false; }
});

// LOGIN
btnLogin.addEventListener('click', async ()=>{
  if(!READY){ setMsg('Still loading Firebase configs.', 'err'); return; }
  showLoginMode();

  const email = document.getElementById('loginEmail').value.trim();
  const password = loginPassword.value;
  const passkey = loginPasskey.value;
  if(!email || !password){ setMsg('Enter email and password.', 'err'); return; }
  if(password !== passkey){ setMsg('Password and Passkey must match.', 'err'); return; }

  showOverlay('Authenticating...'); btnLogin.disabled = btnRegister.disabled = true;
  const persistence = rememberCheckbox.checked ? browserLocalPersistence : browserSessionPersistence;

  try{
    if(INSTANCES.public?.auth) await setPersistence(INSTANCES.public.auth, persistence);
    if(INSTANCES.private?.auth) await setPersistence(INSTANCES.private.auth, persistence);

    let signedUser=null;
    try{const res=await signInWithEmailAndPassword(INSTANCES.public.auth,email,password);signedUser=res.user;}
    catch{try{const res2=await signInWithEmailAndPassword(INSTANCES.private.auth,email,password);signedUser=res2.user;}catch{}}

       if(signedUser){
      const uid=signedUser.uid;
      const profile={email,displayName:signedUser.displayName||'',updatedAt:new Date().toISOString()};
      if(INSTANCES.public?.db) await ensureProfileInDb(INSTANCES.public.db,uid,profile);
      if(INSTANCES.private?.db) await ensureProfileInDb(INSTANCES.private.db,uid,profile);
      showSuccess('Welcome back! Redirecting…');
      hideOverlay(); setMsg('Login successful');
      setTimeout(()=> authFadeAndRedirect(),700);
      return;
    }
    throw new Error('Login failed.');
  }catch(err){ hideOverlay(); setMsg(translateFirebaseError(err),'err'); }
  finally{ btnLogin.disabled = btnRegister.disabled = false; }
});

// ✅ Forgot Password logic
forgotLink.addEventListener('click', async (e)=>{
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  if(!email){ setMsg('Enter your email first to reset password.', 'err'); return; }

  showOverlay('Sending reset email…');
  try{
    let sent = false;
    if(INSTANCES.public?.auth){
      try{ await sendPasswordResetEmail(INSTANCES.public.auth, email); sent = true; }catch{}
    }
    if(!sent && INSTANCES.private?.auth){
      try{ await sendPasswordResetEmail(INSTANCES.private.auth, email); sent = true; }catch{}
    }
    hideOverlay();
    if(sent){
      showSuccess('Password reset email sent!');
      setMsg('Check your inbox for reset link.');
    } else {
      setMsg('Failed to send reset email. Try again.', 'err');
    }
  }catch(err){
    hideOverlay();
    setMsg(translateFirebaseError(err), 'err');
  }
});

function authFadeAndRedirect(){
  authCard.style.transition='opacity .6s,transform .6s';
  authCard.style.opacity='0';
  authCard.style.transform='translateY(12px) scale(.98)';
  setTimeout(()=> window.location.href='global.html',700);
}

// Initialize Firebase
init();
</script>
</body>
</html>