<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Item | Micro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #000; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* üåÄ Micro Percentage Loader */
        #page-loader {
            position: fixed; inset: 0; background: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;
        }
        .spinner-box { position: relative; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 65px; height: 65px; border: 3px solid #111; border-top: 3px solid #2874f0; border-radius: 50%; animation: spin 0.8s linear infinite; }
        #load-percent { position: absolute; font-size: 0.75rem; font-weight: 900; color: #2874f0; font-italic: italic; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* üì∏ Carousel */
        .carousel-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 12px; padding: 10px 0; scrollbar-width: none; justify-content: center; }
        .carousel-container::-webkit-scrollbar { display: none; }
        .carousel-item { flex: 0 0 65%; scroll-snap-align: center; aspect-ratio: 1/1; border-radius: 1.5rem; overflow: hidden; background: #111; border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* üìú Terms Card */
        .glass-card { background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .custom-scroll::-webkit-scrollbar { width: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #2874f0; border-radius: 10px; }

        /* ‚ù§Ô∏è Heart Button */
        #heart-btn.active i { color: #ff4757; transform: scale(1.2); animation: beat 0.3s ease; }
        @keyframes beat { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1.2); } }

        /* ‚≠ê Star Rating */
        .star-active { color: #fbbf24; }
        .star-inactive { color: #222; }
        .picker-star { cursor: pointer; font-size: 1.3rem; transition: 0.2s; }
    </style>
</head>
<body class="pb-32">

    <div id="page-loader">
        <div class="spinner-box">
            <div class="spinner"></div>
            <div id="load-percent">0%</div>
        </div>
        <p class="text-[8px] font-black uppercase tracking-[0.3em] text-zinc-600 mt-4 italic">Fetching Data</p>
    </div>

    <nav class="bg-[#2874f0] fixed top-0 left-0 right-0 z-50 px-4 py-2 flex items-center justify-between h-10 shadow-lg">
        <div class="flex items-center">
            <button onclick="history.back()" class="mr-3 text-white"><i class="fas fa-chevron-left text-sm"></i></button>
            <h1 class="font-black text-[10px] uppercase tracking-tighter italic">Product Details</h1>
        </div>
        <button id="heart-btn" class="text-white p-2 outline-none transition-all"><i class="fa-regular fa-heart text-lg"></i></button>
    </nav>

    <main class="max-w-md mx-auto pt-12 p-5 space-y-6">
        
        <section class="flex flex-col items-center">
            <div id="image-carousel" class="carousel-container w-full">
                <div class="carousel-item flex items-center justify-center"><i class="fas fa-circle-notch fa-spin text-blue-500"></i></div>
            </div>
            <div id="carousel-dots" class="flex justify-center space-x-1.5 mt-3"></div>
        </section>

        <section class="space-y-1 text-center">
            <h2 id="product-name" class="text-2xl font-black uppercase italic tracking-tighter text-white">...</h2>
            <div class="text-blue-500 font-black text-xl" id="product-price">‚Çπ0</div>
            <div class="flex justify-center items-center gap-1.5 mt-1" id="avg-rating-container">
                <div class="flex text-[9px] gap-0.5" id="avg-stars"></div>
                <span class="text-[9px] font-bold text-zinc-500 uppercase italic" id="avg-text">Loading Rating...</span>
            </div>
            <p id="product-desc" class="text-gray-500 text-[11px] leading-relaxed px-4 mt-3">...</p>
        </section>

        <section class="space-y-3">
            <h4 class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-500 flex items-center">
                <i class="fas fa-file-contract mr-2"></i> Purchase Agreement
            </h4>
            <div class="glass-card p-5 rounded-[1.5rem] h-52 overflow-y-auto custom-scroll text-[11px] text-gray-400 leading-relaxed">
                <p class="text-white font-black uppercase italic mb-3 border-b border-white/10 pb-2">Mandatory Rules</p>
                <ul class="space-y-4">
                    <li><b class="text-white block uppercase text-[9px] text-blue-400">1. Physical Shop Pickup</b> You must visit our physical shop location to inspect and collect your product.</li>
                    <li><b class="text-white block uppercase text-[9px] text-blue-400">2. No Return Policy</b> Once you leave the store premises, we strictly do not accept returns or refunds.</li>
                    <li><b class="text-white block uppercase text-[9px] text-blue-400">3. Damage Liability</b> We are not responsible for any damage occurring after purchase or during travel.</li>
                    <li><b class="text-white block uppercase text-[9px] text-blue-400">4. Final Inspection</b> Inspect thoroughly for defects at the counter before acceptance.</li>
                </ul>
            </div>
            <label class="flex items-start space-x-3 p-4 bg-white/5 rounded-2xl border border-white/5 active:bg-white/10 transition">
                <input type="checkbox" id="tc-agree" class="mt-1 w-5 h-5 rounded bg-zinc-800 border-none text-[#2874f0] focus:ring-0">
                <span class="text-[10px] font-bold text-gray-300 uppercase leading-tight">
                    I accept the <span class="text-white font-black">No-Return Policy</span> and will <span class="text-white font-black">Visit the shop</span>.
                </span>
            </label>
        </section>

        <section class="space-y-4 pt-4 border-t border-white/5">
            <h4 class="text-[10px] font-black uppercase tracking-widest text-zinc-500">Public Feedback</h4>
            
            <div class="bg-white/5 p-4 rounded-2xl space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-[9px] font-black uppercase text-zinc-400 italic">Select Rating:</span>
                    <div id="star-picker" class="flex gap-1.5">
                        <i class="fas fa-star picker-star star-inactive" data-val="1"></i>
                        <i class="fas fa-star picker-star star-inactive" data-val="2"></i>
                        <i class="fas fa-star picker-star star-inactive" data-val="3"></i>
                        <i class="fas fa-star picker-star star-inactive" data-val="4"></i>
                        <i class="fas fa-star picker-star star-inactive" data-val="5"></i>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="comment-input" placeholder="Type your review..." class="flex-grow bg-black/50 border border-white/5 rounded-xl px-4 py-2 text-[11px] text-white outline-none focus:border-blue-500 transition">
                    <button id="post-comment" class="bg-blue-600 px-5 rounded-xl text-[10px] font-black uppercase active:scale-90 transition">Post</button>
                </div>
            </div>

            <div id="comments-list" class="space-y-4 mt-2"></div>
        </section>
    </main>

    <div class="fixed bottom-0 left-0 right-0 p-4 bg-black/90 backdrop-blur-md border-t border-white/5 z-40">
        <button id="order-btn" class="w-full bg-blue-600 py-4 rounded-2xl font-black uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all">Secure This Item</button>
    </div>

<script type="module">
    import { auth, db } from 'https://patel-102.github.io/Fantasy/firebase.js';
    import { doc, getDoc, setDoc, deleteDoc, addDoc, collection, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';

    const params = new URLSearchParams(window.location.search);
    const productId = params.get('id');
    let currentUser = null, currentItem = null, userRating = 5;

    // --- üåÄ Percentage Loader Logic ---
    function runLoader() {
        let pct = 0;
        const interval = setInterval(() => {
            pct += Math.floor(Math.random() * 20) + 5;
            if (pct >= 100) {
                document.getElementById('load-percent').innerText = "100%";
                clearInterval(interval);
                setTimeout(() => document.getElementById('page-loader').style.opacity = '0', 200);
                setTimeout(() => document.getElementById('page-loader').style.display = 'none', 500);
            } else { document.getElementById('load-percent').innerText = pct + "%"; }
        }, 60);
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) { currentUser = user; runLoader(); init(); checkFavoriteStatus(); loadComments(); }
        else { window.location.href = "login.html"; }
    });

    // --- ‚≠ê Star Picker UI ---
    const pickerStars = document.querySelectorAll('.picker-star');
    pickerStars.forEach(s => {
        s.onclick = () => {
            userRating = parseInt(s.dataset.val);
            pickerStars.forEach(star => {
                const v = parseInt(star.dataset.val);
                star.className = v <= userRating ? 'fas fa-star picker-star star-active' : 'fas fa-star picker-star star-inactive';
            });
        };
    });

    async function init() {
        if (!productId) { window.location.href='myshop.html'; return; }
        const snap = await getDoc(doc(db, "products", productId));
        if (snap.exists()) {
            currentItem = snap.data();
            document.getElementById('product-name').innerText = currentItem.name;
            document.getElementById('product-price').innerText = currentItem.price;
            document.getElementById('product-desc').innerText = currentItem.description || "In-store check recommended.";
            
            const photos = [currentItem.product_url, ...(currentItem.extra_images || [])];
            document.getElementById('image-carousel').innerHTML = photos.map(url => `
                <div class="carousel-item"><img src="${url}" class="w-full h-full object-cover"></div>
            `).join('');
            document.getElementById('carousel-dots').innerHTML = photos.map((_, i) => `
                <div class="w-1.5 h-1.5 rounded-full bg-white ${i===0 ? 'w-4' : 'opacity-20'} transition-all"></div>
            `).join('');
        }
    }

    // --- üí¨ Load Comments & Average Rating ---
    function loadComments() {
        const q = query(collection(db, "products", productId, "comments"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('comments-list');
            list.innerHTML = "";
            let totalRating = 0;
            let count = 0;

            snap.forEach(doc => {
                const c = doc.data();
                totalRating += c.rating || 5;
                count++;
                
                const stars = Array(5).fill(0).map((_, i) => `<i class="fas fa-star ${i < c.rating ? 'star-active' : 'star-inactive'} text-[7px]"></i>`).join('');
                const date = c.createdAt?.toDate() ? c.createdAt.toDate().toLocaleDateString('en-GB', {day:'2-digit', month:'short'}) : 'Just now';
                
                list.innerHTML += `
                    <div class="border-b border-white/5 pb-3 animate-in fade-in duration-500">
                        <div class="flex justify-between items-start mb-1">
                            <div>
                                <span class="text-[9px] font-black uppercase text-blue-400 italic">${c.userName || 'Member'}</span>
                                <div class="flex gap-0.5 mt-0.5">${stars}</div>
                            </div>
                            <span class="text-[8px] text-zinc-700 font-bold uppercase tracking-tighter">${date}</span>
                        </div>
                        <p class="text-[11px] text-zinc-400 mt-1 leading-relaxed">${c.text}</p>
                    </div>`;
            });

            // Update Average Rating Header
            if(count > 0) {
                const avg = (totalRating / count).toFixed(1);
                document.getElementById('avg-text').innerText = `(${avg} / 5.0 Rating)`;
                document.getElementById('avg-stars').innerHTML = Array(5).fill(0).map((_, i) => `<i class="fas fa-star ${i < Math.round(avg) ? 'star-active' : 'star-inactive'}"></i>`).join('');
            } else {
                document.getElementById('avg-text').innerText = "(No ratings yet)";
            }
        });
    }

    document.getElementById('post-comment').onclick = async () => {
        const input = document.getElementById('comment-input');
        if (!input.value.trim()) return;
        const userSnap = await getDoc(doc(db, "users", currentUser.uid));
        await addDoc(collection(db, "products", productId, "comments"), {
            text: input.value,
            rating: userRating,
            userName: userSnap.data()?.name || "Member",
            createdAt: serverTimestamp()
        });
        input.value = "";
    };

    // --- ‚ù§Ô∏è FAVORITES & ORDERS ---
    async function checkFavoriteStatus() {
        const fav = await getDoc(doc(db, "users", currentUser.uid, "cart", productId));
        if (fav.exists()) document.getElementById('heart-btn').classList.add('active');
    }

    document.getElementById('heart-btn').onclick = async () => {
        const ref = doc(db, "users", currentUser.uid, "cart", productId);
        const btn = document.getElementById('heart-btn');
        if (btn.classList.contains('active')) {
            await deleteDoc(ref); btn.classList.remove('active');
        } else {
            await setDoc(ref, { name: currentItem.name, price: currentItem.price, product_url: currentItem.product_url, savedAt: serverTimestamp() });
            btn.classList.add('active');
        }
    };

    document.getElementById('order-btn').onclick = async () => {
        if (!document.getElementById('tc-agree').checked) return alert("Please accept the Mandatory Rules.");
        await addDoc(collection(db, "orders"), { 
            userId: currentUser.uid, 
            productName: currentItem.name, 
            price: currentItem.price, 
            status: "Pending Pickup", 
            createdAt: serverTimestamp() 
        });
        window.location.href = 'myorder.html';
    };
</script>
</body>
</html>
